# ── ChromaPrint3D core library ────────────────────────────────────────────────

add_library(chromaprint3d STATIC)
add_library(ChromaPrint3D::core ALIAS chromaprint3d)

set_target_properties(chromaprint3d PROPERTIES
    POSITION_INDEPENDENT_CODE ON
    OUTPUT_NAME chromaprint3d)

target_compile_features(chromaprint3d PUBLIC cxx_std_20)

# Generate version.h from template using PROJECT_VERSION
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/include/chromaprint3d/version.h.in
    ${CMAKE_CURRENT_BINARY_DIR}/include/chromaprint3d/version.h
    @ONLY)

# Public headers (build and install paths)
target_include_directories(chromaprint3d PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}/include>
    $<INSTALL_INTERFACE:include>)

# Internal detail headers (not installed)
target_include_directories(chromaprint3d PRIVATE src)

# ── Third-party include paths (build-only) ───────────────────────────────────

target_include_directories(chromaprint3d SYSTEM PUBLIC
    $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/3dparty>)
target_include_directories(chromaprint3d SYSTEM PUBLIC
    $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/3dparty/lib3mf/Autogenerated/Bindings/Cpp>)

set(_opencv_root "${OpenCV_SOURCE_DIR}")
if(NOT _opencv_root)
    set(_opencv_root "${CMAKE_SOURCE_DIR}/3dparty/opencv")
endif()
set(_opencv_build "${OpenCV_BINARY_DIR}")
if(NOT _opencv_build)
    set(_opencv_build "${CMAKE_BINARY_DIR}/3dparty/opencv")
endif()
set(_opencv_cfg_inc "${OPENCV_CONFIG_FILE_INCLUDE_DIR}")
if(NOT _opencv_cfg_inc)
    set(_opencv_cfg_inc "${CMAKE_BINARY_DIR}")
endif()
target_include_directories(chromaprint3d SYSTEM PUBLIC
    $<BUILD_INTERFACE:${_opencv_root}/include>
    $<BUILD_INTERFACE:${_opencv_root}/modules/core/include>
    $<BUILD_INTERFACE:${_opencv_root}/modules/imgproc/include>
    $<BUILD_INTERFACE:${_opencv_root}/modules/imgcodecs/include>
    $<BUILD_INTERFACE:${_opencv_build}>
    $<BUILD_INTERFACE:${_opencv_cfg_inc}>)

# ── Sources ──────────────────────────────────────────────────────────────────

target_sources(chromaprint3d PRIVATE
    src/common/common.cpp
    src/imgproc/imgproc.cpp
    src/color_db/color_db.cpp
    src/match/match.cpp
    src/match/print_profile.cpp
    src/match/recipe_map.cpp
    src/match/model_package.cpp
    src/match/recipe_convert.cpp
    src/match/candidate_select.cpp
    src/calib/calib.cpp
    src/calib/loc.cpp
    src/geo/geo.cpp
    src/geo/export_3mf.cpp
    src/pipeline/pipeline.cpp
    src/encoding/encoding.cpp
    src/logging/logging.cpp)

# ── Dependencies ─────────────────────────────────────────────────────────────

target_link_libraries(chromaprint3d PUBLIC opencv_core opencv_imgproc opencv_imgcodecs)
target_link_libraries(chromaprint3d PUBLIC lib3mf)
target_link_libraries(chromaprint3d PUBLIC spdlog::spdlog_header_only)

find_package(OpenMP)
if(OpenMP_CXX_FOUND)
    target_link_libraries(chromaprint3d PUBLIC OpenMP::OpenMP_CXX)
endif()

# ── Compiler flags (per-build-type, no hardcoded -O3) ────────────────────────

target_compile_options(chromaprint3d PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:RelWithDebInfo>:-O2 -g>)

# ── Install rules ────────────────────────────────────────────────────────────

include(GNUInstallDirs)

install(TARGETS chromaprint3d
    ARCHIVE  DESTINATION ${CMAKE_INSTALL_LIBDIR}
    LIBRARY  DESTINATION ${CMAKE_INSTALL_LIBDIR}
    INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})

install(DIRECTORY include/chromaprint3d
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    FILES_MATCHING PATTERN "*.h")

install(FILES ${CMAKE_CURRENT_BINARY_DIR}/include/chromaprint3d/version.h
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/chromaprint3d)
